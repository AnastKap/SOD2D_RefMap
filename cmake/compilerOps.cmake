message("-- Selecting compiler Ops...")

# Define common C compiler flags
set(CMAKE_C_FLAGS "-DNOPRED")
set(CMAKE_C_FLAGS_DEBUG "-g -O0")
set(CMAKE_C_FLAGS_RELEASE "-O3")

# Define common CXX compiler flags
set(CMAKE_CXX_FLAGS "-DNOPRED")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")
set(CMAKE_CXX_FLAGS_RELEASE "-O3")

# Define common Fortran compiler flags
set(CMAKE_Fortran_FLAGS "-DNOPRED")
set(CMAKE_Fortran_FLAGS_DEBUG "-g -O0")
set(CMAKE_Fortran_FLAGS_RELEASE "-O3")

# Define specific compiler flags
if(CMAKE_C_COMPILER_ID STREQUAL "GNU")
	message("-- GNU compiler detected")
	if (USE_GPU)
		message(FATAL_ERROR "GPU not supported with GNU compiler")
	endif()
	# Common GNNU+MPI flags
	set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-lmpi_cxx -DNOACC")
	set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-lmpi_cxx -DNOACC")
	set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-lmpi_cxx -DNOACC -ffree-line-length-512")
	# Debug
	set(CMAKE_C_FLAGS_DEBUG ${CMAKE_C_FLAGS_DEBUG} "-Wall -Wextra -Wpedantic")
	set(CMAKE_CXX_FLAGS_DEBUG ${CMAKE_CXX_FLAGS_DEBUG} "-Wall -Wextra -Wpedantic")
	set(CMAKE_Fortran_FLAGS_DEBUG ${CMAKE_Fortran_FLAGS_DEBUG} "-Wall -Wextra -Wpedantic -fbacktrace -Wconversion-extra -ftrapv -fcheck=all -ffpe-trap=invalid,zero,overflow,underflow")
	# Release
	set(CMAKE_C_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "-march=native")
	set(CMAKE_CXX_FLAGS_RELEASE ${CMAKE_CXX_FLAGS_RELEASE} "-march=native")
	set(CMAKE_Fortran_FLAGS_RELEASE ${CMAKE_Fortran_FLAGS_RELEASE} "-march=native")
elseif(CMAKE_C_COMPILER_ID STREQUAL "Intel")
	message("-- Intel compiler detected")
	if (USE_GPU)
		message(FATAL_ERROR "GPU not supported with Intel compiler")
	endif()
	# Common Intel+MPI flags
	set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-lmpi_cxx -DNOACC")
	set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-lmpi_cxx -DNOACC")
	set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-lmpi_cxx -DNOACC")
	# Debug
	set(CMAKE_C_FLAGS_DEBUG ${CMAKE_C_FLAGS_DEBUG} "-Werror -traceback -check all -ftrapuv -debug all")
	set(CMAKE_CXX_FLAGS_DEBUG ${CMAKE_CXX_FLAGS_DEBUG} "-Werror -traceback -check all -ftrapuv -debug all")
	set(CMAKE_Fortran_FLAGS_DEBUG ${CMAKE_Fortran_FLAGS_DEBUG} "-Werror -traceback -check all -ftrapuv -debug all -fpe3 -fpe-all=3")
	# Release
	set(CMAKE_C_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "-ipo -no-prec-div -no-prec-sqrt -fp-model fast=2 -qopt-report=5 -qopt-report-phase=vec -qopt-report-phase=par -qopt-report-phase=ipo")
	set(CMAKE_CXX_FLAGS_RELEASE ${CMAKE_CXX_FLAGS_RELEASE} "-ipo -no-prec-div -no-prec-sqrt -fp-model fast=2 -qopt-report=5 -qopt-report-phase=vec -qopt-report-phase=par -qopt-report-phase=ipo")
	set(CMAKE_Fortran_FLAGS_RELEASE ${CMAKE_Fortran_FLAGS_RELEASE} "-ipo -no-prec-div -no-prec-sqrt -fp-model fast=2 -qopt-report=5 -qopt-report-phase=vec -qopt-report-phase=par -qopt-report-phase=ipo")
	if(USE_MN)
		message("Optimizing for MN4")
		set(CMAKE_C_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "-xCORE-AVX512 -mtune=skylake")
		set(CMAKE_CXX_FLAGS_RELEASE ${CMAKE_CXX_FLAGS_RELEASE} "-xCORE-AVX512 -mtune=skylake")
		set(CMAKE_Fortran_FLAGS_RELEASE ${CMAKE_Fortran_FLAGS_RELEASE} "-xCORE-AVX512 -mtune=skylake")
	else()
		set(CMAKE_C_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "-xCORE-AVX2 -mtune=native")
		set(CMAKE_CXX_FLAGS_RELEASE ${CMAKE_CXX_FLAGS_RELEASE} "-xCORE-AVX2 -mtune=native")
		set(CMAKE_Fortran_FLAGS_RELEASE ${CMAKE_Fortran_FLAGS_RELEASE} "-xCORE-AVX2 -mtune=native")
	endif()
elseif(CMAKE_C_COMPILER_ID STREQUAL "NVHPC")
	message("-- NVHPC compiler detected")
	# Common NVHPC+MPI flags
	set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-cpp -lstdc++ -lmpi_cxx -fast -D_USE_NVTX -lnvToolsExt -Minfo=accel")
	set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-cpp -lstdc++ -lmpi_cxx -fast -D_USE_NVTX -lnvToolsExt -Minfo=accel")
	set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-cpp -lstdc++ -lmpi_cxx -fast -D_USE_NVTX -lnvToolsExt -Minfo=accel")
	# Debug
	set(CMAKE_C_FLAGS_DEBUG ${CMAKE_C_FLAGS_DEBUG} "-Mdclchk -Minform=inform -C -Mbounds -Mchkptr -Mchkstk -traceback -Ktrap=fp,unf")
	set(CMAKE_CXX_FLAGS_DEBUG ${CMAKE_CXX_FLAGS_DEBUG} "-Mdclchk -Minform=inform -C -Mbounds -Mchkptr -Mchkstk -traceback -Ktrap=fp,unf")
	set(CMAKE_Fortran_FLAGS_DEBUG ${CMAKE_Fortran_FLAGS_DEBUG} "-Mdclchk -Minform=inform -C -Mbounds -Mchkptr -Mchkstk -traceback -Ktrap=fp,unf")
	# Release
	set(CMAKE_C_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "")
	set(CMAKE_CXX_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "")
	set(CMAKE_Fortran_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} "")
	# GPU options
	if(USE_GPU AND USE_MEM_MANAGED)
		message("Setting up ACC flags with managed memory")
		if(USE_PCPOWER)
			message("Setting up ACC flags with CC70")
			set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-gpu=cc70,cuda10.2,managed,lineinfo -cuda -acc")
			set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-gpu=cc70,cuda10.2,managed,lineinfo -cuda -acc")
			set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-gpu=cc70,cuda10.2,managed,lineinfo -cuda -acc")
		else()
			message("IMPORTANT: Verify the device compute capability!!!")
			set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-gpu=cc61,managed,lineinfo -cuda -acc")
			set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-gpu=cc61,managed,lineinfo -cuda -acc")
			set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-gpu=cc61,managed,lineinfo -cuda -acc")
		endif()
	elseif(USE_GPU)
		message("Setting up ACC flags")
		if(USE_PCPOWER)
			message("Setting up ACC flags with CC70")
			set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-gpu=cc70,cuda10.2,lineinfo -cuda -acc")
			set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-gpu=cc70,cuda10.2,lineinfo -cuda -acc")
			set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-gpu=cc70,cuda10.2,lineinfo -cuda -acc")
		else()
			message("IMPORTANT: Verify the device compute capability!!!")
			set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-gpu=cc61,lineinfo -cuda -acc")
			set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-gpu=cc61,lineinfo -cuda -acc")
			set(CMAKE_Fortran_FLAGS ${CMAKE_Fortran_FLAGS} "-gpu=cc61,lineinfo -cuda -acc")
		endif()
	endif()
else()
	message(FATAL_ERROR "Unknown compiler")
endif()